<!DOCTYPE html><html lang="ja"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.17.2"><title>Mana確率モデル 討論</title><meta name="description" content="Mana が閾値を超えて Meguri が増加する「確率的メカニズム」の設計で、3者の立場が対立している。"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous"><link rel="stylesheet" href="/./_astro/_slug_.CBB1I7NM.css"></head> <body> <header> <nav> <a href="/">Meguri</a> <a href="/discussions/">議論一覧</a> </nav> </header> <main>  <article> <h1>Mana確率モデル 討論</h1> <p>2026-02-15</p> <h1 id="-mana-確率モデル--本格討論">🌸 Mana 確率モデル ── 本格討論</h1>
<p>「ふっと増える」をどう設計するか ── ポアソン・ハイブリッド・非対称設計が激突</p>
<h2 id="争点">争点</h2>
<p>Mana が閾値を超えて Meguri が増加する「確率的メカニズム」の設計で、3者の立場が対立している。</p>
<ul>
<li>**数学者：**非定常ポアソン過程（100%確率）。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Λ</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mi>η</mi><mo>⋅</mo><mtext>Mana</mtext><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Lambda(t) = \eta \cdot \text{Mana}(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Λ</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Mana</span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span>。配分は VRF 均等（1/n）。無記憶性が最適化を構造的に不可能にする。</li>
<li>**ゲーム経済学者：**ハイブリッド型（確定75% + Bloom 25%）。安定性と生き生きした体験の両立。待ち伏せ不能性が攻撃コストを持続コストに変換。</li>
<li>**哲学者：**減衰=決定論・増加=確率の非対称設計。相転移の比喩（水の沸騰）。機会の平等＋期待値の平等が「Meguri 的公平」。</li>
</ul>
<h2 id="round-1--ポアソン100-vs-ハイブリッド安定性の問題">Round 1 ── ポアソン100% vs ハイブリッド：安定性の問題</h2>
<h3 id="ゲーム経済学者">ゲーム経済学者</h3>
<p>数学者、純粋なポアソン過程への懸念を先に言わせてくれ。</p>
<p>ポアソン過程は Mana 量 η に比例した発生率だが、</p>
<p>短期的な分散が非常に大きい</p>
<p>。数学的には Var[N(t)] = E[N(t)] だから、期待値と同じオーダーの揺らぎがある。</p>
<p>ネットワーク初期（巣が少ない）では、</p>
<p>何ヶ月も増加がゼロ、いきなり急増</p>
<p>という体験になる。通貨としての信頼性が損なわれる可能性がある。</p>
<blockquote>
<p>**💡 たとえ話：**バスが「平均1時間に1本」のポアソン過程だとする。1時間待ったのに来ない → さらに30分待ってやっと1本 → その後10分で2本連続。数学的には正しいが、利用者体験はひどい。通貨として使われるものに、この不安定性は致命的かもしれない。</p>
</blockquote>
<h3 id="数学者">数学者</h3>
<p>一部認める</p>
<p>初期の不安定性問題は確かにある。ただ、スケールの問題として捉えるべきだ。</p>
<p>Mana(t) が小さいと Λ(t) も小さくなるから、初期は増加頻度が低くなるのは設計通り。「まだ社会が活発でないから Meguri も増えない」は</p>
<p>世界観的に正しい</p>
<p>。</p>
<p>また、対数正規分布 ΔM で増加量が変動するから、頻度が低くても1回あたりの増加量が補う。長期で見ると、ポアソン過程は</p>
<p>エルゴード性</p>
<p>を持つ。時間平均 = 集団平均が保証される。</p>
<h3 id="ゲーム経済学者-1">ゲーム経済学者</h3>
<p>長期は良くても短期が問題</p>
<p>「長期で見ると公平」は数学的に正しい。でも人間は長期で意思決定しない。</p>
<p>行動経済学の</p>
<p>双曲割引（Hyperbolic Discounting）</p>
<p>によれば、人は近い未来を遠い未来より不当に大きく評価する。「10年後に公平になる」より「今月も来月も何も起きない」の印象が支配する。</p>
<p>ハイブリッドの確定75%は「毎月確実に少しずつ増える」安心感を提供する。これは長期参加を促す実用的な設計だ。</p>
<h3 id="数学者-1">数学者</h3>
<p>それは……認めざるを得ない</p>
<p>双曲割引の指摘は正直に言って刺さる。数学的正しさと人間の体験は別物だ。</p>
<p>ただ一点だけ：確定75%の部分、これは</p>
<p>決定論的蓄積に戻ることになる</p>
<p>。「毎月確実に増える」なら、その部分は最適化可能になる。確定部分の量を最大化しようとする戦略が生まれないか？</p>
<h3 id="ゲーム経済学者-2">ゲーム経済学者</h3>
<p>確定75%は <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>M</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>γ</mi><mo>⋅</mo><mi>Q</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{dM}{dt} = \gamma \cdot Q(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span> で計算される。つまり</p>
<p>「ネットワーク全体の循環の質を上げること」でしか増やせない</p>
<p>。</p>
<p>個人で Q(t) を操作しようとしても、前回の循環議論で出た通り「報酬非連動の公開指標」として設計されているから、個人の利益にならない。確定部分も結局「自然に生活することが最適戦略」に収束する。</p>
<h2 id="round-2--哲学者の非対称設計減衰決定論増加確率は成立するか">Round 2 ── 哲学者の非対称設計：「減衰=決定論・増加=確率」は成立するか</h2>
<h3 id="哲学者">哲学者</h3>
<p>二人の議論、少し整理させてくれ。</p>
<p>私は「</p>
<p>減衰は決定論、増加だけが確率的</p>
<p>」という非対称設計を推す。この非対称性には深い理由がある。</p>
<ul>
<li><strong>減衰が確率的だと</strong>：毎月の支出が予測できない。生活設計が成り立たない悪夢</li>
<li><strong>増加が確率的なのは</strong>：喜びのサプライズ。ボーナスがいつ来るかわからないのは受け入れられる</li>
</ul>
<p>人間の心理として「失うことへの恐怖」は「得ることへの喜び」の約2倍の強さがある（損失回避）。減衰が安定していることが、Meguri 参加の心理的基盤になる。</p>
<blockquote>
<p>**💡 たとえ話：**税金はいつ取られるか分かる（決定論的減衰）。ボーナスはいつもらえるか分からない（確率的増加）。税金がランダムだったら誰も家計を管理できない。でもボーナスのサプライズは「嬉しい誤算」として受け入れられる。この非対称性が人間生活の安定を支えている。</p>
</blockquote>
<h3 id="ゲーム経済学者-3">ゲーム経済学者</h3>
<p>非対称設計に根本的な問題がある</p>
<p>哲学者の心理学的根拠は正しい。でも</p>
<p>ゲーム理論的に非対称設計は危険</p>
<p>だ。</p>
<p>減衰が予測可能なら、プレイヤーは「減衰を最小化する」ことに集中する。具体的には：</p>
<ul>
<li>減衰直前に Meguri を使い切って残高をゼロにする</li>
<li>減衰のタイミングを計算して、最小残高を維持する</li>
<li>「どうせ減るなら早く使え」という心理が蔓延し、人工的な駆け込み需要が生まれる</li>
</ul>
<p>減衰の予測可能性が、かえって</p>
<p>不自然な行動を誘発</p>
<p>するかもしれない。</p>
<h3 id="哲学者-1">哲学者</h3>
<p>……それは鋭い</p>
<p>「どうせ減るなら早く使え」という駆け込み需要か。確かに現実の経済でも、デマリジ通貨（保有コストのある通貨）で同じ現象が起きた事例がある。シルゲジェルのスタンプスクリップがそれだ。</p>
<p>でも少し待って。Meguri の設計では「使うこと自体が循環に貢献する」のだから、駆け込み需要は</p>
<p>むしろ望ましい行動ではないか</p>
<p>？</p>
<p>「減るから使う → 循環が促進される → Mana が蓄積 → Meguri 全体が増える」── これは Meguri の目的と一致している。</p>
<h2 id="round-3--駆け込み需要は良いことをめぐる攻防">Round 3 ── 「駆け込み需要は良いこと？」をめぐる攻防</h2>
<h3 id="ゲーム経済学者-4">ゲーム経済学者</h3>
<p>駆け込み需要は質が悪い</p>
<p>「使うこと = 良い循環」は前回の議論で否定された。</p>
<p>「何でもいいから使えばいい」ではなく、質が重要</p>
<p>だ。</p>
<p>駆け込み需要で生まれる循環は「減衰前に残高を減らすため、誰かに送る」という行動。これは循環の意図が「自分の損失回避」であって「社会への貢献」ではない。さらに受け取った側も「来月減衰する前に送り返す」という連鎖になれば、形だけの循環のループになる。</p>
<p>Q(t) の Path Diversity（経路多様性）が下がる典型パターン。</p>
<h3 id="数学者-2">数学者</h3>
<p>数式で整理する</p>
<p>二人の議論を数式に落とすと、問題の本質が見える。</p>
<p>減衰が完全に予測可能なら、プレイヤーは残高最小化戦略：</p>
<p>B*(t) → 0 直前に送信</p>
<p>を取れる。これが全員の戦略になると、取引はバースト的になる（減衰直前に集中）。</p>
<p>一方、減衰に</p>
<p>微小な確率的ノイズ</p>
<p>を加えると：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo stretchy="false">(</mo><mi>B</mi><mo separator="true">,</mo><mi>τ</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo><mo>+</mo><mi>ε</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\lambda(B,\tau,S) + \varepsilon(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">λ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ε</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span>（ε はゼロ平均の小さな確率変動）。プレイヤーは「いつ減るか完全にはわからない」から、最適化が難しくなる。</p>
<p>「決定論＋微小ノイズ」</p>
<p>は哲学者の「心理的安定」と経済学者の「操作困難性」を両立する第3案かもしれない。</p>
<h3 id="哲学者-2">哲学者</h3>
<p>面白い提案だ</p>
<p>「決定論＋微小ノイズ」── 生命現象でもまさにそれが起きている。</p>
<p>心臓の拍動は基本的に規則正しい（決定論的）だが、完全に機械的ではない。健康な心臓ほど拍動間隔にわずかな揺らぎ（HRV: Heart Rate Variability）がある。この揺らぎが消えると、むしろ病気のサイン。</p>
<p>Meguri の減衰も同じ設計にできる。</p>
<p>基本は予測可能だが、生命らしい微小な揺らぎがある</p>
<p>。「だいたいいつ頃減るかわかるけど、ぴったりは読めない」。これが自然で美しい。</p>
<blockquote>
<p>**💡 たとえ話：**人間の睡眠。「だいたい毎晩11時頃眠くなる」のは規則正しい（決定論的）。でも毎日ぴったり11:00:00に眠るわけじゃない（微小ノイズ）。この揺らぎが人間らしさ。「毎晩11:00:00に強制シャットダウン」はロボット。「バラバラな時間に眠る」は不健康。ちょうど間が「生命らしい」。</p>
</blockquote>
<h2 id="round-4--配分問題vrf均等1nvs-貢献反映">Round 4 ── 配分問題：VRF均等（1/n）vs 貢献反映</h2>
<h3 id="ゲーム経済学者-5">ゲーム経済学者</h3>
<p>配分問題に移ろう。数学者は VRF 均等（1/n）を推すが、私はこれに異議がある。</p>
<p>均等配分でも問題はないが、</p>
<p>「巣の数が多いほど当選確率が増える」</p>
<p>という構造に注意が必要だ。</p>
<p>ネットワーク全体で n 個の巣があり、均等に 1/n の確率。Sybil 攻撃者が k 個の巣を持てば k/n の確率を得る。Sybil 対策（三軸評価）でスコアが低くなっても、確率は巣の数に比例する。つまり</p>
<p>「スコアが低い複数巣 vs スコアが高い1巣」のどちらが有利か？</p>
<p>の計算が必要だ。</p>
<h3 id="数学者-3">数学者</h3>
<p>計算してみよう</p>
<p>数値例で整理する。ネットワーク n = 10,000 巣。</p>
<p>正直プレイヤー（1巣）：</p>
<p>確率 = 1/10,000</p>
<p>Sybil（100巣）：</p>
<p>確率 = 100/10,000 = 100倍</p>
<p>確かに確率は100倍になる。でも Sybil の100巣はすべて三軸スコアが低いから、減価が速い（前回の議論の g(S) 適用）。100巣を維持するコスト（「100の人生を生きる」コスト）と、確率が100倍になる恩恵のROI を比較する必要がある。</p>
<p>Mana から発行される Meguri は「社会全体に均等配分」。100倍の確率で当選しても、受け取る量は1/n の均等配分。</p>
<p>期待値は確率 × 受取量 = (k/n) × (ΔM/n) × k⁻¹ で、実は1巣と変わらない可能性がある。</p>
<h3 id="ゲーム経済学者-6">ゲーム経済学者</h3>
<p>その計算、正しい</p>
<p>待って、確認させてくれ。Bloom Event で ΔM が発生したとき、</p>
<p>当選した1つの巣が ΔM を全部受け取る</p>
<p>のか、それとも</p>
<p>全巣で均等に受け取る</p>
<p>のか？</p>
<p>前者なら Sybil は k/n の確率で ΔM 全額を取れる。後者なら均等配分で k/n × ΔM/n になる。設計の仕方で攻撃の有利不利が逆転する。</p>
<h3 id="数学者-4">数学者</h3>
<p>重要な区別だ</p>
<p>私の提案は「</p>
<p>全巣への均等配分</p>
<p>」。当選した巣が全額を取るのではなく、全員が等しく受け取る。これは前回の議論で出た「雨が全員の畑に等しく降る」モデル。</p>
<p>Bloom Event は「当選者が出る」というより「全体に恵みが降り注ぐ瞬間」として設計する。この場合、Sybil が複数巣を持っても受け取る量は変わらない。</p>
<p>巣の数を増やす動機がゼロになる。</p>
<h3 id="哲学者-3">哲学者</h3>
<p>それが Meguri らしい</p>
<p>「全員に等しく降り注ぐ雨」── この比喩が Meguri の本質と完全に一致する。</p>
<p>雨は「頑張った畑」にも「さぼった畑」にも同じように降る。でも「頑張った畑」は土壌が豊かで雨をよく吸収する（= 高いスコアの巣は健康な状態で恩恵を受け取れる）。「さぼった畑」は土が固くて雨が流れ去る（= スコアが低い巣は恩恵を受け取れる状態にない）。</p>
<p>形式上の均等と、実質的な受容能力の違い。これが自然な差異化になる。</p>
<h2 id="round-5--突破口決定論微小ノイズハイブリッドの統合">Round 5 ── 突破口：「決定論＋微小ノイズ＋ハイブリッド」の統合</h2>
<h3 id="数学者-5">数学者</h3>
<p>統合案を出す</p>
<p>ここまでの議論で全員が部分的に正しかった。統合するとこうなる：</p>
<p>減衰モデル：</p>
<p>λ(B, τ, S) + ε(t)</p>
<p>基本は決定論的に予測可能（心理的安定）。微小ノイズ ε(t) で完全最適化を防ぐ（生命らしい揺らぎ）。</p>
<p>増加モデル（ハイブリッド）：</p>
<p>確定部分（75%）：</p>
<p>dM_base/dt = γ · Q(t)</p>
<p>で Mana が連続蓄積</p>
<p>Bloom 部分（25%）：非定常ポアソン過程で突発的発生</p>
<p>配分：全巣均等</p>
<p>（雨モデル）。当選という概念なし。Bloom が起きた瞬間、全巣に ΔM/n が配布される。</p>
<h3 id="ゲーム経済学者-7">ゲーム経済学者</h3>
<p>ゲーム論的に最良の設計だ</p>
<p>この統合案のゲーム論的含意を確認する。</p>
<p>Sybil 攻撃の ROI：</p>
<p>複数巣を持っても配分は変わらない。三軸スコアが下がるので減衰が速くなる。複数巣のコストだけかかる → 完全にペイしない。</p>
<p>最適戦略：</p>
<p>自然に生活する = 1巣で三軸スコアが高い状態を維持 = 減衰が遅く、健康な状態で Bloom を受け取れる。</p>
<p>体験の豊かさ：</p>
<p>毎月じわじわ増える安心感 + 予測不能な Bloom のドキドキ。この組み合わせが長期参加を促す。</p>
<h3 id="哲学者-4">哲学者</h3>
<p>世界観としても完璧</p>
<p>「決定論＋微小ノイズ＋Bloom」の三層構造、生命論的に言うと：</p>
<ul>
<li><strong>決定論的減衰</strong>：呼吸するだけで少し消耗する（代謝）</li>
<li><strong>微小ノイズ</strong>：今日は少し調子がいい、悪い（生命の揺らぎ）</li>
<li><strong>Mana 蓄積→ Bloom</strong>：蓄積と相転移（水が沸騰するように「ふっと」起きる）</li>
<li><strong>雨モデルの均等配分</strong>：生態系全体に恵みが降り注ぐ</li>
</ul>
<p>これは生命の比喩として完全に一貫している。人間の意図が入り込む余地がない。</p>
<p>それが Meguri の「脱所有」を完成させる。</p>
<h2 id="最終結論">最終結論</h2>
<h2 id="用語集">用語集</h2>
<h3 id="ポアソン過程">ポアソン過程</h3>
<p><strong>今回の議論：</strong> Λ(t) = η·Mana(t) で Mana が多いほど Bloom が起きやすくなる</p>
<h3 id="ハイブリッドモデル確定75--bloom-25">ハイブリッドモデル（確定75% + Bloom 25%）</h3>
<p><strong>今回の議論：</strong> 固定給（安心感）＋ボーナス（サプライズ）の組み合わせ</p>
<h3 id="非対称設計減衰決定論増加確率">非対称設計（減衰=決定論・増加=確率）</h3>
<p><strong>今回の議論：</strong> 税金はいつ取られるかわかる。ボーナスはいつもらえるかわからない。この非対称性が人間生活の安定を支える</p>
<h3 id="微小ノイズ-εt">微小ノイズ ε(t)</h3>
<h3 id="雨モデル全巣均等配分">雨モデル（全巣均等配分）</h3>
<p><strong>今回の議論：</strong> 雨は全員の畑に等しく降る。頑張った畑（高スコア）は土壌が豊かで雨をよく吸収する</p>
<h3 id="双曲割引">双曲割引</h3>
<h3 id="エルゴード性">エルゴード性</h3>
<h3 id="相転移bloom-の比喩">相転移（Bloom の比喩）</h3> </article>  </main> </body></html> <script>
(function () {
  var article = document.querySelector('article');
  if (!article) return;

  var speakerMap = {
    '数学者': 'mathematician',
    'ゲーム経済学者': 'economist',
    '哲学者': 'philosopher',
    'アーキテクト': 'architect',
    'architect': 'architect',
    '議事録係': 'other',
    '春日': 'other',
  };

  var nodes = Array.from(article.childNodes);
  var frag = document.createDocumentFragment();
  var speakerContent = null;
  var inGlossary = false;
  var glossarySection = null;
  var glossaryItem = null;

  nodes.forEach(function (el) {
    if (el.nodeType !== 1) return; // skip text nodes
    var tag = el.tagName;
    var txt = el.textContent.trim();

    if (tag === 'H2') {
      speakerContent = null; glossaryItem = null;

      if (/^Round\s*\d+/.test(txt) || /^最終結論/.test(txt)) {
        el.classList.add('round-divider');
        inGlossary = false;
        frag.appendChild(el);
      } else if (txt === '用語集') {
        glossarySection = document.createElement('div');
        glossarySection.className = 'glossary-section';
        var gh = el.cloneNode(true);
        glossarySection.appendChild(gh);
        frag.appendChild(glossarySection);
        inGlossary = true;
      } else {
        inGlossary = false;
        frag.appendChild(el);
      }

    } else if (tag === 'H3') {
      if (inGlossary && glossarySection) {
        glossaryItem = document.createElement('div');
        glossaryItem.className = 'glossary-item';
        glossaryItem.appendChild(el);
        glossarySection.appendChild(glossaryItem);
        speakerContent = glossaryItem;
      } else {
        var speakerKey = null;
        Object.keys(speakerMap).forEach(function (k) {
          if (txt.indexOf(k) !== -1) speakerKey = k;
        });
        var cls = speakerKey ? speakerMap[speakerKey] : 'other';
        var block = document.createElement('div');
        block.className = 'speaker-block speaker-' + cls;
        var label = document.createElement('div');
        label.className = 'speaker-label';
        label.textContent = speakerKey || txt;
        speakerContent = document.createElement('div');
        speakerContent.className = 'speaker-content';
        block.appendChild(label);
        block.appendChild(speakerContent);
        frag.appendChild(block);
      }

    } else {
      if (speakerContent) {
        speakerContent.appendChild(el);
      } else if (inGlossary && glossarySection) {
        glossarySection.appendChild(el);
      } else {
        frag.appendChild(el);
      }
    }
  });

  article.innerHTML = '';
  article.appendChild(frag);
})();
</script>