<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meguri - 討論: 長期離脱からの復帰パスを設計する</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }

        /* ===== 左ペイン ===== */
        .left-pane {
            background: #161b22;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #30363d;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .left-pane h3 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .participant {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: #0d1117;
            border-radius: 8px;
            border-left: 4px solid #30363d;
        }

        .participant.math { border-left-color: #7ee787; }
        .participant.econ { border-left-color: #d2a8ff; }
        .participant.phil { border-left-color: #ffa657; }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0d1117;
            font-weight: bold;
            margin-right: 10px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .participant.math .avatar { background: #7ee787; }
        .participant.econ .avatar { background: #d2a8ff; }
        .participant.phil .avatar { background: #ffa657; }

        .participant-info h4 { font-size: 13px; color: #c9d1d9; margin-bottom: 2px; }
        .participant-info p { font-size: 11px; color: #8b949e; }

        .nav-section { margin-top: 20px; }
        .nav-section h3 { margin-bottom: 10px; }

        .nav-link {
            display: block;
            padding: 7px 10px;
            margin-bottom: 5px;
            background: #0d1117;
            border-radius: 6px;
            color: #8b949e;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-link:hover { color: #58a6ff; background: #1c2128; border-left-color: #58a6ff; }
        .nav-link .nav-num { color: #484f58; margin-right: 6px; font-weight: 600; }

        /* ===== 中央ペイン ===== */
        .center-pane {
            background: #161b22;
            border-radius: 12px;
            padding: 30px;
            border: 1px solid #30363d;
        }

        .center-pane h1 { color: #58a6ff; margin-bottom: 6px; font-size: 22px; line-height: 1.3; }

        .phase-badge {
            display: inline-block;
            padding: 3px 10px;
            background: rgba(88,166,255,0.15);
            border: 1px solid #1f6feb;
            border-radius: 20px;
            font-size: 11px;
            color: #58a6ff;
            margin-bottom: 8px;
        }

        .center-pane > .subtitle {
            color: #8b949e;
            font-size: 13px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }

        .topic-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-left: 4px solid #58a6ff;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 28px;
        }

        .topic-box h3 { color: #58a6ff; font-size: 14px; margin-bottom: 10px; }
        .topic-box p { font-size: 13px; line-height: 1.7; color: #8b949e; }

        .thread-break {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 32px 0 24px;
        }

        .thread-break .tb-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, #30363d, transparent);
        }

        .thread-break .tb-label {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 20px;
            padding: 4px 14px;
            font-size: 11px;
            color: #58a6ff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0d1117;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 14px;
            margin-top: 4px;
        }

        .message.math .message-avatar { background: #7ee787; }
        .message.econ .message-avatar { background: #d2a8ff; }
        .message.phil .message-avatar { background: #ffa657; }

        .message-content { max-width: 90%; }

        .speaker-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            padding-left: 4px;
        }

        .speaker-name { font-size: 11px; font-weight: 700; }
        .message.math .speaker-name { color: #7ee787; }
        .message.econ .speaker-name { color: #d2a8ff; }
        .message.phil .speaker-name { color: #ffa657; }

        .emotion {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .emotion.challenge { background: rgba(248,81,73,0.15); color: #f85149; border: 1px solid rgba(248,81,73,0.3); }
        .emotion.agree    { background: rgba(126,231,135,0.15); color: #7ee787; border: 1px solid rgba(126,231,135,0.3); }
        .emotion.doubt    { background: rgba(227,179,65,0.15); color: #e3b341; border: 1px solid rgba(227,179,65,0.3); }
        .emotion.propose  { background: rgba(88,166,255,0.15); color: #58a6ff; border: 1px solid rgba(88,166,255,0.3); }

        .speech-bubble {
            background: #1c2128;
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid #30363d;
            font-size: 13.5px;
            line-height: 1.75;
            color: #c9d1d9;
        }

        .message.math .speech-bubble { border-left: 3px solid #7ee787; }
        .message.econ .speech-bubble { border-left: 3px solid #d2a8ff; }
        .message.phil .speech-bubble { border-left: 3px solid #ffa657; }

        .speech-bubble strong { color: #e6edf3; }
        .speech-bubble ul, .speech-bubble ol { padding-left: 20px; margin: 8px 0; }
        .speech-bubble li { margin-bottom: 5px; font-size: 13px; }

        .analogy {
            margin: 10px 0 0;
            padding: 10px 14px;
            border-radius: 8px;
            background: rgba(227,179,65,0.06);
            border-left: 3px solid #e3b341;
            font-size: 13px;
            line-height: 1.7;
            color: #8b949e;
        }

        .analogy strong { color: #e3b341; }

        .resolution-box {
            background: #0d2d0d;
            border: 1px solid #1a4d1a;
            border-left: 4px solid #3fb950;
            padding: 20px 24px;
            margin: 32px 0 0;
            border-radius: 10px;
        }

        .resolution-box h3 { color: #3fb950; font-size: 15px; margin-bottom: 14px; }
        .resolution-box ul { padding-left: 20px; margin-top: 10px; }
        .resolution-box li { margin-bottom: 8px; font-size: 13px; line-height: 1.6; color: #c9d1d9; }
        .resolution-box strong { color: #7ee787; }

        .open-issue-box {
            background: #1c1200;
            border: 1px solid #4d3300;
            border-left: 4px solid #e3b341;
            padding: 16px 20px;
            margin: 20px 0 0;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.7;
        }

        .open-issue-box strong { color: #e3b341; }
        .open-issue-box ul { padding-left: 20px; margin-top: 8px; }
        .open-issue-box li { margin-bottom: 6px; color: #c9d1d9; }

        /* ===== 右ペイン ===== */
        .right-pane {
            background: #161b22;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #30363d;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .right-pane h3 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .accordion {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .accordion-item { border: 1px solid #30363d; border-radius: 8px; overflow: hidden; }

        .accordion-header {
            background: #0d1117;
            padding: 11px 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 12.5px;
            user-select: none;
            transition: background 0.2s;
            color: #c9d1d9;
        }

        .accordion-header:hover { background: #1c2128; }
        .accordion-header.active { background: #1f6feb; color: #fff; }
        .accordion-icon { transition: transform 0.3s; font-size: 10px; }
        .accordion-header.active .accordion-icon { transform: rotate(180deg); }

        .accordion-content {
            display: none;
            padding: 12px 14px;
            background: #0d1117;
            font-size: 12px;
            line-height: 1.7;
            border-top: 1px solid #30363d;
            color: #8b949e;
        }

        .accordion-content.active { display: block; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0d1117; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #58a6ff; }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr 1fr; }
            .left-pane { grid-column: 1; }
            .center-pane { grid-column: 2; }
            .right-pane { grid-column: 1 / -1; position: relative; top: 0; }
        }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .left-pane, .center-pane, .right-pane { grid-column: auto; position: relative; top: 0; }
            .center-pane { padding: 20px; }
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="container">

        <!-- ===== 左ペイン ===== -->
        <div class="left-pane">
            <h3>Participants</h3>

            <div class="participant phil">
                <div class="avatar">P</div>
                <div class="participant-info">
                    <h4>philosopher</h4>
                    <p>世界観・倫理基盤</p>
                </div>
            </div>

            <div class="participant math">
                <div class="avatar">M</div>
                <div class="participant-info">
                    <h4>mathematician</h4>
                    <p>数式・不正防止</p>
                </div>
            </div>

            <div class="participant econ">
                <div class="avatar">G</div>
                <div class="participant-info">
                    <h4>game-economist</h4>
                    <p>ゲーム論・機制設計</p>
                </div>
            </div>

            <div class="nav-section">
                <h3>Navigation</h3>
                <a href="#round1" class="nav-link"><span class="nav-num">R1</span>問題の確認と不正防止</a>
                <a href="#round2" class="nav-link"><span class="nav-num">R2</span>デバイス紐づけによる復帰証明</a>
                <a href="#round3" class="nav-link"><span class="nav-num">R3</span>Grace Period の設計</a>
                <a href="#round4" class="nav-link"><span class="nav-num">R4</span>合意と再定式化</a>
            </div>
        </div>

        <!-- ===== 中央ペイン ===== -->
        <div class="center-pane">
            <span class="phase-badge">Phase 2 — R2-3 検討</span>
            <h1>長期離脱からの復帰パスを設計する</h1>
            <p class="subtitle">病気・災害で離脱した巣の救済メカニズムを、不正を許さずに実装する</p>

            <div class="topic-box">
                <h3>討論の核心</h3>
                <p>Phase 2-06（静寂閾値：90日無活動で分母Nから除外）と Phase 2-01（減衰加速）の組み合わせで、長期離脱者は通貨がゼロに近づいて復帰困難になる。これは「自然に存在するものを保護する」という Meguri の世界観と矛盾する。しかし、単に grace period を与えるだけでは「復帰と詐称」を区別できず、Sybil 攻撃に利用される。デバイス紐づけを活用して、本当の復帰者を証明しながら保護する仕組みを検討する。</p>
            </div>

            <!-- ===== Round 1 ===== -->
            <div class="thread-break" id="round1">
                <div class="tb-line"></div>
                <div class="tb-label">Round 1 &mdash; 問題の確認と不正防止の課題</div>
                <div class="tb-line"></div>
            </div>

            <div class="message phil">
                <div class="message-avatar">P</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">philosopher</span>
                        <span class="emotion challenge">問題提起</span>
                    </div>
                    <div class="speech-bubble">
                        外部レビューで指摘された通り、<strong>現在の設計は事実上のデジタル追放</strong>だ。<br><br>
                        病気や災害で90日間動けなかった人を考えてほしい。その人は：<br>
                        <ul>
                            <li>分母Nから除外されて配分がゼロになり</li>
                            <li>同時に減価が加速して通貨が消滅し</li>
                            <li>復帰しても何も残っていない</li>
                        </ul>
                        「自然に存在するものを守る」って言ったのに、自然な離脱（病気や災害）を罰している。これは矛盾している。<br><br>
                        ただし一つの工夫：<strong>「復帰です」という詐称を許してはいけない</strong>。つまり「復帰したい」と言ってきた人が、本当にその巣の所有者なのか、それとも Sybil 攻撃者が別人のふりをしているのかを区別する必要がある。
                    </div>
                </div>
            </div>

            <div class="message math">
                <div class="message-avatar">M</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">mathematician</span>
                        <span class="emotion agree">同意し、技術的に検討</span>
                    </div>
                    <div class="speech-bubble">
                        philosopher の指摘は正しい。そして「所有者であることの証明」はすでに解決済みだ。<br><br>
                        Phase 2-02（第4軸：デバイス紐づけ）で、各巣は「デバイス固有ID」と紐づけられている。つまり：<br>
                        <ul>
                            <li>長期離脱していたユーザーが同じデバイルで復帰申請 → <strong>その人物と巣の同一性が暗号学的に証明される</strong></li>
                            <li>別の人が他のデバイスから「その巣を復帰させたい」と言っても → <strong>デバイスが異なるから拒否</strong></li>
                        </ul>
                        これで「本当の復帰」と「詐称」を区別できる。<br><br>
                        ただし心配なのは：復帰時に一度に全配分を受け取られたら、その後すぐに何度も離脱・復帰を繰り返す攻略法が出てくるのでは？
                    </div>
                </div>
            </div>

            <div class="message econ">
                <div class="message-avatar">G</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">game-economist</span>
                        <span class="emotion propose">段階的回復案</span>
                    </div>
                    <div class="speech-bubble">
                        mathematician の懸念はもっともだ。復帰の詐称は防げるが、「反復的な離脱・復帰」の濫用は防ぐ必要がある。<br><br>
                        提案：<strong>「段階的な grace period」</strong><br>
                        <ul>
                            <li>デバイス紐づけで復帰が証明された → 一度だけ grace period 開始</li>
                            <li>その grace period 中（例：30日）は、配分が100%保障される</li>
                            <li>30日後、正常な活動に戻る → 配分再開</li>
                            <li><strong>ただし、grace period 中に再び90日無活動になったら → 新しい grace period は付与されない（1回限り）</strong></li>
                        </ul>
                        これで「本当の長期離脱者は救済する」「反復的な濫用は防ぐ」両方できる。
                    </div>
                </div>
            </div>

            <!-- ===== Round 2 ===== -->
            <div class="thread-break" id="round2">
                <div class="tb-line"></div>
                <div class="tb-label">Round 2 &mdash; デバイス紐づけの仕組み確認</div>
                <div class="tb-line"></div>
            </div>

            <div class="message math">
                <div class="message-avatar">M</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">mathematician</span>
                        <span class="emotion propose">復帰フロー</span>
                    </div>
                    <div class="speech-bubble">
                        game-economist の段階的 grace period 案に同意する。数学的に言い直すと：<br><br>
                        <code>grace_remaining(v) = 0 initially</code><br>
                        復帰申請時：<br>
                        <code>IF device_match(v_申請, v_記録) AND grace_remaining(v) == 0 THEN<br>
                        　　grace_remaining(v) ← 30日<br>
                        　　配分 ← 100% × (ΔM / N)<br>
                        END</code><br><br>
                        重要な点：<br>
                        <ul>
                            <li><code>device_match()</code>：デバイスID が巣の記録と一致するか暗号学的に検証</li>
                            <li><code>grace_remaining(v) == 0</code>：以前の grace period がもう残っていないか確認</li>
                            <li>grace period 中でも「正常な活動」が続けば、grace 期間後は完全に回復</li>
                        </ul>
                        これでデバイス交換時はどうするか？という問題が出てくる。
                    </div>
                </div>
            </div>

            <div class="message phil">
                <div class="message-avatar">P</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">philosopher</span>
                        <span class="emotion doubt">デバイス交換時の懸念</span>
                    </div>
                    <div class="speech-bubble">
                        いいアイデアだが、<strong>デバイスが壊れたり、新しく買い替えたりしたらどうなる？</strong><br><br>
                        例えば：<br>
                        <ul>
                            <li>iPhone を 5年使って、バッテリーが死んで Android に乗り替えた人</li>
                            <li>水に落とした人</li>
                            <li>盗まれた人</li>
                        </ul>
                        こういう人たちは「本当にその人」なのに、デバイスが違うから「詐称者」と見なされてしまう。<br><br>
                        つまり：デバイス紐づけは Sybil 攻撃を防ぐには強力だが、<strong>正当な人の利便性を損ねる</strong>。どうバランスを取る？
                    </div>
                </div>
            </div>

            <div class="message econ">
                <div class="message-avatar">G</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">game-economist</span>
                        <span class="emotion propose">デバイス移行プロセス</span>
                    </div>
                    <div class="speech-bubble">
                        重要な指摘だ。解決案：<strong>「デバイス移行の grace period」</strong><br><br>
                        <ul>
                            <li>旧デバイス（スマホが壊れた直後）で最後の取引から30日以内に</li>
                            <li>新デバイスから「デバイス移行申請」をする</li>
                            <li>その新デバイスに新しく紐づけ直す</li>
                        </ul>
                        これにより：<br>
                        <ul>
                            <li>本当のデバイス破損・交換は許可（30日の猶予）</li>
                            <li>長期間経過した「昔のデバイスで新しい巣を作る」詐称は防止（30日後は新デバイス固定）</li>
                        </ul>
                        つまり<strong>「複数のデバイス移行」は許可するが、その間隔に制限を付ける</strong>。
                    </div>
                </div>
            </div>

            <!-- ===== Round 3 ===== -->
            <div class="thread-break" id="round3">
                <div class="tb-line"></div>
                <div class="tb-label">Round 3 &mdash; Grace Period の長さと仕様確定</div>
                <div class="tb-line"></div>
            </div>

            <div class="message math">
                <div class="message-avatar">M</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">mathematician</span>
                        <span class="emotion propose">復帰フロー（改定版）</span>
                    </div>
                    <div class="speech-bubble">
                        game-economist のデバイス移行プロセスを組み込んだ、完全な復帰フロー：<br><br>
                        <strong>ケース1：同じデバイスで復帰</strong><br>
                        <code>IF device_match(申請) AND 静寂状態 AND grace_used == FALSE THEN<br>
                        　　grace_period ← 30日<br>
                        　　配分率 ← 100%<br>
                        　　grace_used ← TRUE<br>
                        END</code><br><br>
                        <strong>ケース2：デバイス交換後の復帰</strong><br>
                        <code>IF device_mismatch(申請) AND 最終取引から30日以内 THEN<br>
                        　　new_device ← 申請元デバイス<br>
                        　　grace_period ← 30日<br>
                        　　配分率 ← 100%<br>
                        　　grace_used ← TRUE<br>
                        END</code><br><br>
                        つまり「同一デバイス」か「30日以内の新デバイス」なら grace_period を付与。grace_period は巣ごとに1回限り。
                    </div>
                </div>
            </div>

            <div class="message phil">
                <div class="message-avatar">P</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">philosopher</span>
                        <span class="emotion agree">倫理的に整合</span>
                    </div>
                    <div class="speech-bubble">
                        この設計なら「自然に存在するものを保護する」という原則と一致する。<br><br>
                        <strong>保護される人たち：</strong><br>
                        <ul>
                            <li>病気や災害で長期離脱した人 → 復帰時に grace period で救済</li>
                            <li>デバイスが壊れた人 → 新デバイスでの移行を30日以内に認める</li>
                        </ul>
                        <strong>防止される悪用：</strong><br>
                        <ul>
                            <li>「離脱・復帰」を何度も繰り返す game → grace period は1回限り</li>
                            <li>「古い巣を装う」Sybil → デバイス一致が必須。または30日以内の新デバイス移行に限定</li>
                        </ul>
                        Meguri の脱所有理念を守りながら、不正も防ぐ。いい。
                    </div>
                </div>
            </div>

            <div class="message econ">
                <div class="message-avatar">G</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">game-economist</span>
                        <span class="emotion agree">ゲーム論的に確認</span>
                    </div>
                    <div class="speech-bubble">
                        ゲーム論的に分析すると：<br><br>
                        <strong>攻撃者の視点：</strong><br>
                        <code>複数デバイスで巣を量産 → 各巣で1回だけ grace period を使う？</code><br>
                        → これは Phase 2-02（第4軸：1デバイス = 1主要な巣）で既に防止済み。複数デバイス自体が高コスト。<br><br>
                        <strong>正直者の視点：</strong><br>
                        「病気で動けなかった」「デバイスが壊れた」という自然な事象に対して、ペナルティなしで復帰できる。インセンティブ構造が正直者に有利。<br><br>
                        支配戦略は変わらない：「自然に存在する」ことが最適戦略。
                    </div>
                </div>
            </div>

            <!-- ===== Round 4 ===== -->
            <div class="thread-break" id="round4">
                <div class="tb-line"></div>
                <div class="tb-label">Round 4 &mdash; 合意と再定式化</div>
                <div class="tb-line"></div>
            </div>

            <div class="message phil">
                <div class="message-avatar">P</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">philosopher</span>
                        <span class="emotion agree">合意</span>
                    </div>
                    <div class="speech-bubble">
                        R2-3 の解決案に合意する。<br><br>
                        <strong>復帰パスの設計原則：</strong><br>
                        <ul>
                            <li><strong>デバイス紐づけで本人確認</strong>：「本当の復帰」と「詐称」を区別</li>
                            <li><strong>1回限りの grace period（30日）</strong>：反復的濫用を防止しながら、真の困窮者を救済</li>
                            <li><strong>デバイス交換の猶予（30日）</strong>：自然な機器交換を許可</li>
                        </ul>
                        これで Meguri の「自然に存在するものを保護する」という哲学と、「構造的に不正を無力化する」という技術が両立する。
                    </div>
                </div>
            </div>

            <div class="message math">
                <div class="message-avatar">M</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">mathematician</span>
                        <span class="emotion agree">合意</span>
                    </div>
                    <div class="speech-bubble">
                        数学的にも整合している。最終仕様：<br><br>
                        <code>restore_grace_period(v, device_申請) {<br>
                        　　IF静寂状態(v) {<br>
                        　　　　IF device_match(device_申請, v.device_record) {<br>
                        　　　　　　← ケース1：同じデバイス<br>
                        　　　　　　grace_remaining(v) ← 30日, grace_used ← TRUE<br>
                        　　　　} ELSE IF (NOW - last_tx(v)) ≤ 30日 {<br>
                        　　　　　　← ケース2：最近のデバイス交換<br>
                        　　　　　　v.device_record ← device_申請<br>
                        　　　　　　grace_remaining(v) ← 30日, grace_used ← TRUE<br>
                        　　　　}<br>
                        　　}<br>
                        }</code><br><br>
                        grace_remaining(v) > 0 の期間は、配分 = 100% × (ΔM / N) を保障。
                    </div>
                </div>
            </div>

            <div class="message econ">
                <div class="message-avatar">G</div>
                <div class="message-content">
                    <div class="speaker-header">
                        <span class="speaker-name">game-economist</span>
                        <span class="emotion agree">合意</span>
                    </div>
                    <div class="speech-bubble">
                        ゲーム論的に支配戦略は維持される。合意する。
                    </div>
                </div>
            </div>

            <!-- ===== 合意ボックス ===== -->
            <div class="resolution-box">
                <h3>合意事項</h3>
                <ul>
                    <li><strong>復帰パスの設計原則</strong>：デバイス紐づけで本人確認、1回限りの grace period で反復濫用防止、30日以内のデバイス交換を許可</li>
                    <li><strong>Grace Period の仕様（30日）</strong>：静寂状態から復帰した巣に対して、1回限り30日間の完全な配分保障。この期間中に正常な活動に戻れば、その後は通常に復帰。</li>
                    <li><strong>デバイス交換プロセス</strong>：最終取引から30日以内の新デバイスからの申請なら、デバイス紐づけを変更して grace period を付与。30日以上経過した場合は新しい巣として扱う。</li>
                    <li><strong>2重の不正防止</strong>：grace period は巣ごとに1回限り（反復濫用防止）。複数デバイスでの巣量産は Phase 2-02 の第4軸で既に防止済み。</li>
                    <li><strong>倫理的整合性</strong>：病気・災害による自然な離脱は救済する一方で、構造的にはペナルティなし。「自然に存在するものを保護する」という Meguri の原則を実装。</li>
                </ul>
            </div>

            <div class="open-issue-box">
                <strong>残課題</strong>
                <ul>
                    <li><strong>Grace period 中の静寂判定の調整</strong>：grace period の30日間、静寂検査をスキップするか、それとも通常通り行うか。もし30日間無活動なら grace の意味が無いため、30日以内に1回でも取引があれば静寂フラグ解除とする。</li>
                    <li><strong>デバイス交換時の履歴管理</strong>：複数回のデバイス交換を経た巣の履歴追跡。改ざんや詐称を検出するシグネチャ。</li>
                    <li><strong>Grace period 付与のトリガー</strong>：ユーザーが明示的に「復帰申請」するのか、それとも自動検出するのか。UX の観点からも設計が必要。</li>
                </ul>
            </div>
        </div>

        <!-- ===== 右ペイン ===== -->
        <div class="right-pane">
            <h3>Glossary</h3>
            <div class="accordion" id="glossary">

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        復帰パス（Restoration Path）
                        <span class="accordion-icon">&#9660;</span>
                    </div>
                    <div class="accordion-content active">
                        <p>長期離脱（90日以上無活動）から復帰する際の仕組み。デバイス紐づけで本人確認を行い、1回限りの grace period を付与することで、真の困窮者を救済しながら Sybil 攻撃を防止する。</p>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        デバイス紐づけ復帰確認
                        <span class="accordion-icon">&#9660;</span>
                    </div>
                    <div class="accordion-content">
                        <p>復帰申請時に、デバイス固有ID（TPM、Secure Enclave など）が巣の記録と一致するか暗号学的に検証する。一致すれば「本当の所有者の復帰」と認定。一致しない場合は、最後の取引から30日以内の新デバイスなら移行を許可。</p>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        復帰用 Grace Period（30日）
                        <span class="accordion-icon">&#9660;</span>
                    </div>
                    <div class="accordion-content">
                        <p>静寂状態から復帰が確認された巣に対して、1回限り30日間付与される配分保障期間。この間は、巣は通常通り 100% × (ΔM / N) の配分を受け取る。</p>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        デバイス交換猶予（30日）
                        <span class="accordion-icon">&#9660;</span>
                    </div>
                    <div class="accordion-content">
                        <p>デバイスが壊れたり、機器交換したりした場合、最後の取引から30日以内であれば新しいデバイスからの復帰申請を認める。これにより、スマートフォン故障などの自然な事象に対応。30日経過した場合は「新しい巣」として扱われる。</p>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        function toggleAccordion(header) {
            const allHeaders = document.querySelectorAll('.accordion-header');
            allHeaders.forEach(h => {
                if (h !== header) {
                    h.classList.remove('active');
                    h.nextElementSibling.classList.remove('active');
                }
            });
            header.classList.toggle('active');
            header.nextElementSibling.classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const firstHeader = document.querySelector('.accordion-header');
            if (firstHeader) {
                firstHeader.classList.add('active');
                firstHeader.nextElementSibling.classList.add('active');
            }
        });
    </script>
</body>

</html>
